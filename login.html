<?php 
// Database connection (ensure this file contains the proper connection details)
require_once 'db_connection.php';

// Check if user is trying to register
if (isset($_POST['register'])) {
    $email = $_POST['email'];
    $password = $_POST['password'];
    $confirm_password = $_POST['confirm_password'];

    // Email validation
    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        echo "Invalid email format!";
        exit;
    }

    // Password validation (strong password policy)
    if (strlen($password) < 8) {
        echo "Password must be at least 8 characters long!";
        exit;
    }
    if (!preg_match("/[A-Z]/", $password) || !preg_match("/[a-z]/", $password) || !preg_match("/[0-9]/", $password) || !preg_match("/[\W_]/", $password)) {
        echo "Password must contain at least one uppercase letter, one lowercase letter, one number, and one special character!";
        exit;
    }

    // Password match check
    if ($password !== $confirm_password) {
        echo "Passwords do not match!";
        exit;
    }

    // Check if email already exists in database
    $stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
    $stmt->execute([$email]);
    if ($stmt->rowCount() > 0) {
        echo "Email already registered!";
        exit;
    }

    // Hash password before storing
    $hashed_password = password_hash($password, PASSWORD_DEFAULT);

    // Generate a unique token for email verification
    $token = bin2hex(random_bytes(16));
    $verification_link = "http://yourwebsite.com/verify_email.php?token=" . $token;

    // Insert user into database
    $stmt = $pdo->prepare("INSERT INTO users (email, password, verification_token, is_verified) VALUES (?, ?, ?, ?)");
    if ($stmt->execute([$email, $hashed_password, $token, 0])) {
        // Send verification email
        mail($email, "Email Verification", "Please verify your email by clicking on the following link: " . $verification_link);

        echo "Registration successful. Please check your email to verify your account!";
    } else {
        echo "Something went wrong, please try again!";
    }
}

// Check if user is trying to login
if (isset($_POST['login'])) {
    $email = $_POST['email'];
    $password = $_POST['password'];

    // Validate email format
    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        echo "Invalid email format!";
        exit;
    }

    // Retrieve user details from database
    $stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
    $stmt->execute([$email]);
    $user = $stmt->fetch();

    if ($user) {
        // Check if email is verified
        if ($user['is_verified'] == 0) {
            echo "Please verify your email before logging in!";
            exit;
        }

        // Verify password
        if (password_verify($password, $user['password'])) {
            // Start session and set session variables
            session_start();
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['email'] = $user['email'];

            // Redirect to dashboard or main page
            header("Location: dashboard.php");
            exit;
        } else {
            echo "Incorrect password!";
            exit;
        }
    } else {
        echo "User not found!";
        exit;
    }
}

// Password reset functionality (optional feature)
if (isset($_POST['reset_password'])) {
    $email = $_POST['email'];
    
    // Validate email format
    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        echo "Invalid email format!";
        exit;
    }

    // Check if email exists
    $stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
    $stmt->execute([$email]);
    $user = $stmt->fetch();

    if ($user) {
        // Generate a unique token for password reset
        $token = bin2hex(random_bytes(16));
        $reset_link = "http://yourwebsite.com/reset_password.php?token=" . $token;

        // Store the reset token in the database (with expiration time)
        $stmt = $pdo->prepare("UPDATE users SET reset_token = ?, reset_token_expiry = ? WHERE email = ?");
        $expiry_time = time() + 3600; // Token expires in 1 hour
        $stmt->execute([$token, $expiry_time, $email]);

        // Send password reset email
        mail($email, "Password Reset", "You can reset your password by clicking on the following link: " . $reset_link);

        echo "Password reset email sent!";
    } else {
        echo "Email not found!";
        exit;
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“š VED WEBNOVEL HUB - JOIN US!</title>
    <style>
        /* ðŸ”¥ GLOBAL STYLES */
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background: linear-gradient(to right, #0c0c0c, #1b1b1b);
            color: white;
            margin: 0;
            padding: 0;
            animation: fadeIn 1s ease-in;
        }

        /* ðŸ”¥ HEADER */
        header {
            background: #181818;
            padding: 25px;
            font-size: 32px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: glowEffect 2s infinite alternate;
        }

        @keyframes glowEffect {
            0% { text-shadow: 0 0 15px #facc15; }
            100% { text-shadow: 0 0 25px #facc15, 0 0 40px #facc15; }
        }

        /* ðŸ”¥ NAVBAR */
        nav {
            background: #292929;
            padding: 12px;
        }
        nav a {
            color: white;
            text-decoration: none;
            margin: 0 18px;
            font-size: 18px;
            transition: 0.3s;
        }
        nav a:hover {
            color: #facc15;
            text-shadow: 0 0 10px #facc15;
            transform: scale(1.1);
        }

        /* ðŸ”¥ MAIN CONTENT AREA */
        .container {
            margin: 50px auto;
            max-width: 950px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.3);
            animation: slideIn 1s ease-in-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ðŸ”¥ CALL-TO-ACTION BUTTONS */
        .cta-btn {
            background: #facc15;
            color: #0c0c0c;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 22px;
            text-decoration: none;
            display: inline-block;
            margin: 15px 20px;
            transition: 0.3s;
        }
        .cta-btn:hover {
            background: #ffcb00;
            transform: scale(1.1);
        }

        /* ðŸ”¥ FOOTER */
        footer {
            background: #111;
            padding: 18px;
            font-size: 14px;
            margin-top: 35px;
        }

        /* ðŸ”¥ FORM STYLES */
        .form-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            margin: 20px auto;
            max-width: 500px;
        }

        input {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid #fff;
            color: white;
            background: #333;
        }

        input[type="submit"] {
            background: #facc15;
            color: #0c0c0c;
            border: none;
            cursor: pointer;
        }

        input[type="submit"]:hover {
            background: #ffcb00;
        }
    </style>
</head>
<body>

<header>VED WEBNOVEL HUB - JOIN US!</header>

<nav>
    <a href="home.php">Home</a>
    <a href="about.php">About</a>
    <a href="contact.php">Contact</a>
</nav>

<div class="container">
    <h2>Register or Login</h2>
    
    <form method="POST" class="form-container">
        <input type="email" name="email" placeholder="Email Address" required><br>
        <input type="password" name="password" placeholder="Password" required><br>
        <input type="password" name="confirm_password" placeholder="Confirm Password" required><br>
        <input type="submit" name="register" value="Register">
    </form>

    <form method="POST" class="form-container">
        <input type="email" name="email" placeholder="Email Address" required><br>
        <input type="password" name="password" placeholder="Password" required><br>
        <input type="submit" name="login" value="Login">
    </form>
    
    <form method="POST" class="form-container">
        <input type="email" name="email" placeholder="Email Address" required><br>
        <input type="submit" name="reset_password" value="Reset Password">
    </form>
</div>

<footer>ðŸ“š VED WEBNOVEL HUB 2025. All rights reserved.</footer>

</body>
</html>
